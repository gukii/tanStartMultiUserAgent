# Multi-User Collaboration Harness

A real-time multiplayer form collaboration system built with TanStack Start and PartyKit. Enables multiple users to work together on forms with cursor tracking, field locking, and live synchronization.

## âœ¨ Features

- ğŸ–±ï¸ **Real-time Cursor Tracking** - See where everyone is pointing
- ğŸ”’ **Smart Field Locking** - Automatic field locking with 3-second inactivity eviction
- ğŸ’¬ **Cursor Messages** - Quick communication via cursor tooltips
- ğŸ“± **Touch Cursor Painting** - Paint your cursor position on mobile devices
- ğŸ”„ **Live Field Sync** - Changes sync instantly across all users
- ğŸ¨ **Color-coded Users** - Each user gets a unique color
- âš¡ **Optimistic Updates** - Instant UI feedback
- ğŸ” **CRDT-lite** - Last-write-wins conflict resolution

## ğŸš€ Quick Start

### Local Development

```bash
# Install dependencies
pnpm install

# Start PartyKit server (terminal 1)
pnpm dev:party

# Start TanStack app (terminal 2)
pnpm dev

# Open http://localhost:3000/demo in multiple tabs
```

### Deploy to Production

See [DEPLOYMENT.md](./DEPLOYMENT.md) for complete deployment instructions.

**Quick deploy:**

```bash
# 1. Deploy PartyKit
npx partykit deploy

# 2. Note your URL (e.g., collaboration-harness.YOUR-USER.partykit.dev)

# 3. Push to GitHub and deploy to Railway
# 4. Set VITE_PARTYKIT_HOST in Railway environment variables
```

## ğŸ® Usage Patterns

The harness can be used in multiple ways:

1. **Layout Route** (Recommended) - Wrap multiple routes with `_collab.tsx`
2. **Per-Route** - Wrap individual route components
3. **Component-Level** - Wrap reusable form components
4. **Conditional** - Enable only for specific users/contexts

See [UNIVERSAL_USAGE.md](./UNIVERSAL_USAGE.md) for detailed patterns and examples.

### Quick Example (Layout Route)

```tsx
// src/routes/_collab.tsx
<CollaborationHarness roomId={autoGenerated}>
  <Outlet /> {/* All child routes get collaboration */}
</CollaborationHarness>

// src/routes/_collab/checkout.tsx
<CheckoutForm /> {/* Automatically collaborative! */}
```

## ğŸ® Features Guide

### Field Locking

- **Focus a field** â†’ Automatically locks to you
- **Others see gray readonly field** with lock icon
- **Double-click a locked field** â†’ Takes control (if owner inactive 3+ seconds)
- **Red shake animation** â†’ Eviction blocked (owner still active)

### Cursor Messages

- Type in the **"Cursor message"** input box
- Press **Enter** to broadcast
- Message appears next to your cursor
- Perfect for coaching and pointing

### Touch Cursor (Mobile)

- Toggle **"Touch Cursor"** button ON
- Drag finger across screen to paint cursor
- Other users see your cursor position in real-time

## ğŸ—ï¸ Architecture

### Tech Stack

- **Frontend**: TanStack Start (React + Vite)
- **Backend**: PartyKit (WebSocket server)
- **Styling**: Tailwind CSS
- **State**: React hooks + CRDT-lite

### Key Components

- `CollaborationHarness.tsx` - Main wrapper component
- `GhostCursor.tsx` - Remote cursor rendering
- `party/server.ts` - PartyKit WebSocket server
- `types/collaboration.ts` - Shared TypeScript types

### Message Flow

```
User A types â†’ FIELD_ACTIVITY â†’ Server â†’ User B (updates timestamp)
User A focuses â†’ FIELD_FOCUS â†’ Server â†’ User B (shows lock)
User B double-clicks â†’ FORCE_FIELD_FOCUS â†’ Server â†’ User A (gets evicted)
```

## ğŸ“ Environment Variables

Create `.env` (or use Railway environment variables):

```bash
# PartyKit WebSocket server (without https://)
VITE_PARTYKIT_HOST=127.0.0.1:1999  # local
# VITE_PARTYKIT_HOST=your-project.your-user.partykit.dev  # production
```

## ğŸ§ª Testing

Open `/demo` route in multiple browser tabs/windows:

1. **Cursor Sync**: Move mouse in tab 1, see cursor in tab 2
2. **Field Lock**: Focus field in tab 1, try typing in tab 2 (blocked)
3. **Field Sync**: Type in unlocked field, see text appear in other tab
4. **Eviction**: Lock field, wait 3 seconds, double-click from other tab
5. **Messages**: Set cursor message, see it appear on other cursor

## ğŸ› ï¸ Development

```bash
# Run dev servers
pnpm dev          # TanStack Start
pnpm dev:party    # PartyKit

# Build for production
pnpm build        # Builds both client and server

# Preview production build
pnpm preview

# Deploy PartyKit server
pnpm deploy:party
```

## ğŸ› Troubleshooting

### Cursors not syncing
- Check browser console for WebSocket errors
- Verify `VITE_PARTYKIT_HOST` is correct (no `https://` prefix)
- Ensure PartyKit server is running: `npx partykit list`

### Field locking not working
- Check console logs: `[FORCE LOCK]` messages
- Verify both clients are connected (green dot visible)
- Try refreshing both tabs

### Touch cursor not working
- Toggle must be ON (button shows purple when active)
- Only works on touch devices (check with real device, not emulator)
- Check console for `[TOUCH]` logs

## ğŸ“š Documentation

- [DEPLOYMENT.md](./DEPLOYMENT.md) - Deployment guide
- [CLAUDE.md](./CLAUDE.md) - Project guidelines for AI assistants
- [PartyKit Docs](https://docs.partykit.io/)
- [TanStack Start Docs](https://tanstack.com/start)

## ğŸ¯ Use Cases

- **Form Co-editing**: Multiple people filling out the same form
- **Customer Support**: Guide users through forms in real-time
- **Workshops**: Instructor demonstrates while students follow
- **Pair Programming**: Collaborate on form-heavy applications
- **User Testing**: Observe and guide users remotely

## ğŸ“„ License

MIT

## ğŸ¤ Contributing

This is a demonstration project. Feel free to fork and adapt for your needs.

## ğŸ”— Links

- [Railway](https://railway.app/) - Deployment platform
- [PartyKit](https://www.partykit.io/) - WebSocket server hosting
- [TanStack Start](https://tanstack.com/start) - Full-stack React framework
